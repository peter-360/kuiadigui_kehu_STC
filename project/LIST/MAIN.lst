C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\hex\MAIN.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\user\MAIN.C LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\user) DEBUG OBJE
                    -CTEXTEND PRINT(.\LIST\MAIN.lst) TABS(2) OBJECT(..\hex\MAIN.obj)

line level    source

   1          /*                        -- ¶ÉºÓÂìÒÏµç×Ó¹¤×÷ÊÒ --                        */
   2          /*
   3          *   Ëµ    Ã÷: STC8A8KS4A12 DEMO³ÌÐò
   4          *   ¿ª·¢Æ½Ì¨: STC15W408S     
   5          *   ÌÔ±¦Íøµê: 
   6          *
   7          //  ÎÄ¼þÃû£ºmain.c                                                              
   8          //  ËµÃ÷£º¹©¿Í»§²âÊÔÄ£¿éÍ¨ÐÅÊ¹ÓÃ³ÌÐò                                                                  
   9          //  ±àÐ´ÈËÔ±£ºDuhemayi                                                                   
  10          //  ±àÐ´ÈÕÆÚ£º2018-09-16                                                               
  11          //  ³ÌÐòÎ¬»¤£º
  12          //  Î¬»¤¼ÇÂ¼£º
  13          //  °æ    ±¾: V1.0
  14          //                                                          
  15          // ÃâÔðÉùÃ÷£º¸Ã³ÌÐò½öÓÃÓÚÑ§Ï°Óë½»Á÷ 
  16          // (c) Duhemayi Corporation. All rights reserved.     
  17          ******************************************************************************/
  18          #include "config.h"
  19          
  20          
  21          
  22          
  23          
  24          
  25          
  26          void spear_uart_send_datas(uint8* str, uint8 len)
  27          {
  28   1        while(len--)
  29   1        {
  30   2      //    USART_SendData(USART1, *str);
  31   2      //    while (USART_GetFlagStatus(USART1, USART_FLAG_TC) == RESET); 
  32   2      //    str++;
  33   2          UartSend(*str++);
  34   2        }
  35   1      }
  36          
  37          void debug_uart_send_datas(uint8* str, uint8 len)
  38          {
  39   1        UartSend(0xee);
  40   1        while(len--)
  41   1        {
  42   2      //    USART_SendData(USART1, *str);
  43   2      //    while (USART_GetFlagStatus(USART1, USART_FLAG_TC) == RESET); 
  44   2      //    str++;
  45   2          UartSend(*str++);
  46   2        }
  47   1        UartSend(0xff);
  48   1      }
  49          
  50          
  51          
  52          void debug_uart_send_data1(uint8 str)
  53          {
  54   1        UartSend(0xee);
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 2   

  55   1        UartSend(str);
  56   1        UartSend(0xff);
  57   1      }
  58          
  59          
  60          
  61          ///command struct
  62          typedef struct
  63          {
  64            //uint8_t type;
  65            uint8_t opcode;
  66            
  67            uint8_t board_addr;
  68            uint8_t lock_addr;//-------
  69            uint8_t gu_ding;//---
  70            
  71            uint8_t bcc;
  72          }command1_struct;
  73          
  74          /////start process the data in
  75          
  76          command1_struct m_data;
  77          
  78          
  79          void lock_all_off(void)
  80          {
  81   1        GO_1=0;
  82   1        //GI_1=0;
  83   1      
  84   1        GO_2=0;
  85   1        //GI_2=0;
  86   1      
  87   1        GO_3=0;
  88   1        //GI_3=0;
  89   1      
  90   1      
  91   1        GO_4=0;
  92   1        //GI_4=0;
  93   1      
  94   1        GO_5=0;
  95   1        //GI_5=0;
  96   1      
  97   1        GO_6=0;
  98   1        //GI_6=0;
  99   1      
 100   1        GO_7=0;
 101   1        //GI_7=0;
 102   1      
 103   1        GO_8=0;
 104   1        //GI_8=0;
 105   1      
 106   1        GO_9=0;
 107   1        //GI_9=0;
 108   1      
 109   1        GO_10=0;
 110   1        //GI_10=0;
 111   1      
 112   1        GO_11=0;
 113   1        //GI_11=0;
 114   1      
 115   1        GO_12=0;
 116   1        //GI_12=0;
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 3   

 117   1      
 118   1        GO_13=0;
 119   1        //GI_13=0;
 120   1      
 121   1        GO_14=0;
 122   1        //GI_14=0;
 123   1      
 124   1        GO_15=0;
 125   1        //GI_15=0;
 126   1      
 127   1        GO_16=0;
 128   1        //GI_16=0;
 129   1      
 130   1        GO_17=0;
 131   1        //GI_17=0;
 132   1      
 133   1        GO_18=0;
 134   1        //GI_18=0;
 135   1      
 136   1        GO_19=0;
 137   1        //GI_19=0;
 138   1      
 139   1        GO_20=0;
 140   1        //GI_20=0;
 141   1      
 142   1        GO_21=0;
 143   1        //GI_21=0;
 144   1      
 145   1        GO_22=0;
 146   1        //GI_22=0;
 147   1      
 148   1        GO_23=0;
 149   1        //GI_23=0;
 150   1      
 151   1        GO_24=0;
 152   1        //GI_24=0;  
 153   1      
 154   1      }
 155          
 156          
 157          void lock_all_on_off(void)
 158          {
 159   1      
 160   1        GO_1=1;           //open
 161   1        delay_ms(100);  //>=20
 162   1        if(1==GI_1)//no open
 163   1        {
 164   2          //debug_uart_send_data1(0x01);
 165   2          delay_ms(300);
 166   2        }
 167   1        if(1==GI_1)//no open
 168   1        {
 169   2          //debug_uart_send_data1(0x02);
 170   2          delay_ms(600);
 171   2        }
 172   1        GO_1=0;           //close
 173   1        delay_ms(500);
 174   1      
 175   1      
 176   1        //LED1 =1;
 177   1      
 178   1        
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 4   

 179   1        GO_2=1;              //open
 180   1        delay_ms(100);  //>=20
 181   1        if(1==GI_2)//no open
 182   1        {
 183   2          delay_ms(300);
 184   2        }
 185   1        if(1==GI_2)//no open
 186   1        {
 187   2          delay_ms(600);
 188   2        }
 189   1        GO_2=0;              //close
 190   1        //LED1 =0;
 191   1        delay_ms(500);LED1=!LED1;
 192   1      
 193   1        
 194   1        
 195   1        GO_3=1;              //open
 196   1        delay_ms(100);  //>=20
 197   1        if(1==GI_3)//no open
 198   1        {
 199   2          delay_ms(300);
 200   2        }
 201   1        if(1==GI_3)//no open
 202   1        {
 203   2          delay_ms(600);
 204   2        }
 205   1        GO_3=0;              //close
 206   1        delay_ms(500);LED1=!LED1;
 207   1      
 208   1      
 209   1        GO_4=1;              //open
 210   1        delay_ms(100);  //>=20
 211   1        if(1==GI_4)//no open
 212   1        {
 213   2          delay_ms(300);
 214   2        }
 215   1        if(1==GI_4)//no open
 216   1        {
 217   2          delay_ms(600);
 218   2        } 
 219   1        GO_4=0;              //close
 220   1        delay_ms(500);LED1=!LED1;
 221   1      
 222   1      
 223   1        GO_5=1;              //open
 224   1        delay_ms(100);  //>=20
 225   1        if(1==GI_5)//no open
 226   1        {
 227   2          delay_ms(300);
 228   2        }
 229   1        if(1==GI_5)//no open
 230   1        {
 231   2          delay_ms(600);
 232   2        } 
 233   1        GO_5=0;              //close
 234   1        delay_ms(500);LED1=!LED1;
 235   1      
 236   1      
 237   1        GO_6=1;              //open
 238   1        delay_ms(100);  //>=20
 239   1        if(1==GI_6)//no open
 240   1        {
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 5   

 241   2          delay_ms(300);
 242   2        }
 243   1        if(1==GI_6)//no open
 244   1        {
 245   2          delay_ms(600);
 246   2        }
 247   1        GO_6=0;              //close
 248   1        delay_ms(500);LED1=!LED1;
 249   1      
 250   1      
 251   1        GO_7=1;              //open
 252   1        delay_ms(100);  //>=20
 253   1        if(1==GI_7)//no open
 254   1        {
 255   2          delay_ms(300);
 256   2        }
 257   1        if(1==GI_7)//no open
 258   1        {
 259   2          delay_ms(600);
 260   2        }
 261   1        GO_7=0;              //close
 262   1        delay_ms(500);LED1=!LED1;
 263   1      
 264   1      
 265   1        GO_8=1;              //open
 266   1        delay_ms(100);  //>=20
 267   1        if(1==GI_8)//no open
 268   1        {
 269   2          delay_ms(300);
 270   2        }
 271   1        if(1==GI_8)//no open
 272   1        {
 273   2          delay_ms(600);
 274   2        }
 275   1        GO_8=0;              //close
 276   1        delay_ms(500);LED1=!LED1;
 277   1        
 278   1      
 279   1        GO_9=1;              //open
 280   1        delay_ms(100);  //>=20
 281   1        if(1==GI_9)//no open
 282   1        {
 283   2          delay_ms(300);
 284   2        }
 285   1        if(1==GI_9)//no open
 286   1        {
 287   2          delay_ms(600);
 288   2        }
 289   1        GO_9=0;              //close
 290   1        delay_ms(500);LED1=!LED1;
 291   1      
 292   1      
 293   1        GO_10=1;               //open
 294   1        delay_ms(100);  //>=20
 295   1        if(1==GI_10)//no open
 296   1        {
 297   2          delay_ms(300);
 298   2        }
 299   1        if(1==GI_10)//no open
 300   1        {
 301   2          delay_ms(600);
 302   2        } 
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 6   

 303   1        GO_10=0;               //close
 304   1        delay_ms(500);LED1=!LED1;
 305   1      
 306   1      
 307   1        GO_11=1;               //open
 308   1        delay_ms(100);  //>=20
 309   1        if(1==GI_11)//no open
 310   1        {
 311   2          delay_ms(300);
 312   2        }
 313   1        if(1==GI_11)//no open
 314   1        {
 315   2          delay_ms(600);
 316   2        } 
 317   1        GO_11=0;               //close
 318   1        delay_ms(500);LED1=!LED1;
 319   1      
 320   1      
 321   1        GO_12=1;               //open
 322   1        delay_ms(100);  //>=20
 323   1        if(1==GI_12)//no open
 324   1        {
 325   2          delay_ms(300);
 326   2        }
 327   1        if(1==GI_12)//no open
 328   1        {
 329   2          delay_ms(600);
 330   2        } 
 331   1        GO_12=0;               //close
 332   1        delay_ms(500);LED1=!LED1;
 333   1      
 334   1      
 335   1        GO_13=1;               //open
 336   1        delay_ms(100);  //>=20
 337   1        if(1==GI_13)//no open
 338   1        {
 339   2          delay_ms(300);
 340   2        }
 341   1        if(1==GI_13)//no open
 342   1        {
 343   2          delay_ms(600);
 344   2        } 
 345   1        GO_13=0;               //close
 346   1        delay_ms(500);LED1=!LED1;
 347   1      
 348   1      
 349   1        GO_14=1;               //open
 350   1        delay_ms(100);  //>=20
 351   1        if(1==GI_14)//no open
 352   1        {
 353   2          delay_ms(300);
 354   2        }
 355   1        if(1==GI_14)//no open
 356   1        {
 357   2          delay_ms(600);
 358   2        } 
 359   1        GO_14=0;               //close
 360   1        delay_ms(500);LED1=!LED1;
 361   1      
 362   1      
 363   1        GO_15=1;               //open
 364   1        delay_ms(100);  //>=20
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 7   

 365   1        if(1==GI_15)//no open
 366   1        {
 367   2          delay_ms(300);
 368   2        }
 369   1        if(1==GI_15)//no open
 370   1        {
 371   2          delay_ms(600);
 372   2        } 
 373   1        GO_15=0;               //close
 374   1        delay_ms(500);LED1=!LED1;
 375   1      
 376   1      
 377   1        GO_16=1;               //open
 378   1        delay_ms(100);  //>=20
 379   1        if(1==GI_16)//no open
 380   1        {
 381   2          delay_ms(300);
 382   2        }
 383   1        if(1==GI_16)//no open
 384   1        {
 385   2          delay_ms(600);
 386   2        } 
 387   1        GO_16=0;               //close
 388   1        delay_ms(500);LED1=!LED1;
 389   1      
 390   1      
 391   1        GO_17=1;               //open
 392   1        delay_ms(100);  //>=20
 393   1        if(1==GI_17)//no open
 394   1        {
 395   2          delay_ms(300);
 396   2        }
 397   1        if(1==GI_17)//no open
 398   1        {
 399   2          delay_ms(600);
 400   2        } 
 401   1        GO_17=0;               //close
 402   1        delay_ms(500);LED1=!LED1;
 403   1      
 404   1      
 405   1        GO_18=1;               //open
 406   1        delay_ms(100);  //>=20
 407   1        if(1==GI_18)//no open
 408   1        {
 409   2          delay_ms(300);
 410   2        }
 411   1        if(1==GI_18)//no open
 412   1        {
 413   2          delay_ms(600);
 414   2        } 
 415   1        GO_18=0;               //close
 416   1        delay_ms(500);LED1=!LED1;
 417   1      
 418   1      
 419   1        GO_19=1;               //open
 420   1        delay_ms(100);  //>=20
 421   1        if(1==GI_19)//no open
 422   1        {
 423   2          delay_ms(300);
 424   2        }
 425   1        if(1==GI_19)//no open
 426   1        {
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 8   

 427   2          delay_ms(600);
 428   2        } 
 429   1        GO_19=0;               //close
 430   1        delay_ms(500);LED1=!LED1;
 431   1      
 432   1      
 433   1        GO_20=1;               //open
 434   1        delay_ms(100);  //>=20
 435   1        if(1==GI_20)//no open
 436   1        {
 437   2          delay_ms(300);
 438   2        }
 439   1        if(1==GI_20)//no open
 440   1        {
 441   2          delay_ms(600);
 442   2        }   
 443   1        GO_20=0;               //close
 444   1        delay_ms(500);LED1=!LED1;
 445   1      
 446   1      
 447   1        
 448   1        GO_21=1;               //open
 449   1        delay_ms(100);  //>=20
 450   1        if(1==GI_21)//no open
 451   1        {
 452   2          delay_ms(300);
 453   2        }
 454   1        if(1==GI_21)//no open
 455   1        {
 456   2          delay_ms(600);
 457   2        }  
 458   1        GO_21=0;               //close
 459   1        delay_ms(500);LED1=!LED1;
 460   1      
 461   1      
 462   1        GO_22=1;               //open
 463   1        delay_ms(100);  //>=20
 464   1        if(1==GI_22)//no open
 465   1        {
 466   2          delay_ms(300);
 467   2        }
 468   1        if(1==GI_22)//no open
 469   1        {
 470   2          delay_ms(600);
 471   2        } 
 472   1        GO_22=0;               //close
 473   1        delay_ms(500);LED1=!LED1;
 474   1      
 475   1      
 476   1        GO_23=1;               //open
 477   1        delay_ms(100);  //>=20
 478   1        if(1==GI_23)//no open
 479   1        {
 480   2          delay_ms(300);
 481   2        }
 482   1        if(1==GI_23)//no open
 483   1        {
 484   2          delay_ms(600);
 485   2        } 
 486   1        GO_23=0;               //close
 487   1        delay_ms(500);LED1=!LED1;
 488   1      
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 9   

 489   1      
 490   1        GO_24=1;               //open
 491   1        delay_ms(100);  //>=20
 492   1        if(1==GI_24)//no open
 493   1        {
 494   2          delay_ms(300);
 495   2        }
 496   1        if(1==GI_24)//no open
 497   1        {
 498   2          delay_ms(600);
 499   2        } 
 500   1        GO_24=0;               //close
 501   1        
 502   1        lock_all_off();
 503   1      
 504   1      }
 505          uint8_t ComputXor(uint8_t *InData, uint16_t Len)
 506          {
 507   1        uint8_t Sum = 0;
 508   1        uint16_t i;
 509   1        for(i = 0; i < Len; i++)
 510   1        {
 511   2          Sum ^= InData[i]; 
 512   2        }
 513   1        return Sum;
 514   1      }
 515          
 516          void data_parse()
 517          {
 518   1        uint8_t bcc_temp;
 519   1        uint8_t tx_Buffer[256]={0};        //?????
 520   1        //uint8_t length = 0;             //??
 521   1        uint8_t gpio_level=0;
 522   1        uint8_t grp_level_1;
 523   1        uint8_t grp_level_2;
 524   1        uint8_t grp_level_3;
 525   1        uint8_t board_addr;
 526   1        
 527   1        uint8_t Uart1_Buffer_T[256]={0};        //?????
 528   1        uint8_t Uart1_Rx_T = 0;             //??
 529   1        
 530   1        uint8_t DSW_T_1, DSW_T_2, DSW_T_3, DSW_T_4, DSW_T_5, DSW_T_6 ;
 531   1        
 532   1        uint8_t GI_T_1=GI_1,   GI_T_2=GI_2,   GI_T_3=GI_3,   GI_T_4=GI_4,   GI_T_5=GI_5,   GI_T_6=GI_6,
 533   1                GI_T_7=GI_7,   GI_T_8=GI_8,   GI_T_9=GI_9,   GI_T_10=GI_10, GI_T_11=GI_11, GI_T_12=GI_12, 
 534   1                GI_T_13=GI_13, GI_T_14=GI_14, GI_T_15=GI_15, GI_T_16=GI_16, GI_T_17=GI_17, GI_T_18=GI_18,
 535   1                GI_T_19=GI_19, GI_T_20=GI_20, GI_T_21=GI_21, GI_T_22=GI_22, GI_T_23=GI_23, GI_T_24=GI_24;
 536   1        
 537   1                
 538   1        //SEGGER_RTT_printf(0, "-parse-Uart1_Rx = %d\n",Uart1_Rx);      //RTT´òÓ¡
 539   1        Uart1_Rx_T = Uart1_Rx - 8;
 540   1        //SEGGER_RTT_printf(0, "-Uart1_Rx_T = %d\n",Uart1_Rx_T);      //RTT´òÓ
 541   1        memcpy(Uart1_Buffer_T,Uart1_Buffer+4,Uart1_Rx_T);
 542   1        
 543   1        DSW_T_1 = ~DSW_1;
 544   1        DSW_T_2 = ~DSW_2;
 545   1        DSW_T_3 = ~DSW_3;
 546   1        DSW_T_4 = ~DSW_4;
 547   1        DSW_T_5 = ~DSW_5;
 548   1        DSW_T_6 = ~DSW_6;
 549   1        board_addr= DSW_T_1 | (DSW_T_2<<1) | (DSW_T_3<<2) | (DSW_T_4<<3) | (DSW_T_5<<4) | (DSW_T_6<<5) ;
 550   1        
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 10  

 551   1        //UartSend(board_addr);
 552   1        if(board_addr == Uart1_Buffer_T[1])//todo
 553   1        {
 554   2          if(5==Uart1_Rx_T)
 555   2          {
 556   3            m_data.opcode = Uart1_Buffer_T[0];
 557   3            m_data.board_addr = Uart1_Buffer_T[1];// to do
 558   3            m_data.lock_addr = Uart1_Buffer_T[2];//
 559   3            m_data.gu_ding = Uart1_Buffer_T[3];//
 560   3            m_data.bcc = Uart1_Buffer_T[4];
 561   3      
 562   3            bcc_temp = ComputXor(Uart1_Buffer_T,4);
 563   3            //SEGGER_RTT_printf(0, "bcc_temp = %x\n",bcc_temp);
 564   3            if(bcc_temp == m_data.bcc)
 565   3            {
 566   4              switch(m_data.opcode)
 567   4              {
 568   5                case 0x8A:
 569   5                  //----1------
 570   5                  if(m_data.gu_ding  == 0x11)//process
 571   5                  {
 572   6                    //UartSend(m_data.lock_addr);
 573   6                    switch(m_data.lock_addr)
 574   6                    {     
 575   7                      case 1:
 576   7                        GO_1=1;           //open
 577   7                        delay_ms(100);  //>=20
 578   7                        if(1==GI_1)//no open
 579   7                        {
 580   8                          //debug_uart_send_data1(0x01);
 581   8                          delay_ms(300);
 582   8                        }
 583   7                        if(1==GI_1)//no open
 584   7                        {
 585   8                          //debug_uart_send_data1(0x02);
 586   8                          delay_ms(600);
 587   8                        }
 588   7                        GO_1=0;           //close
 589   7      
 590   7                      
 591   7                        //LED1 =1;
 592   7                        gpio_level= GI_1;
 593   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 594   7                        //UartSendStr("\r\n--1--\r\n");
 595   7                        
 596   7                        break;
 597   7                      
 598   7                      case 2:
 599   7                        GO_2=1;              //open
 600   7                        delay_ms(100);  //>=20
 601   7                        if(1==GI_2)//no open
 602   7                        {
 603   8                          delay_ms(300);
 604   8                        }
 605   7                        if(1==GI_2)//no open
 606   7                        {
 607   8                          delay_ms(600);
 608   8                        }
 609   7                        GO_2=0;              //close
 610   7      
 611   7      
 612   7                        //LED1 =0;
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 11  

 613   7                        gpio_level= GI_2;
 614   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 615   7                        break;
 616   7                      
 617   7                    case 3:
 618   7                        GO_3=1;              //open
 619   7                        delay_ms(100);  //>=20
 620   7                        if(1==GI_3)//no open
 621   7                        {
 622   8                          delay_ms(300);
 623   8                        }
 624   7                        if(1==GI_3)//no open
 625   7                        {
 626   8                          delay_ms(600);
 627   8                        }
 628   7                        GO_3=0;              //close
 629   7      
 630   7                        gpio_level= GI_3;
 631   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 632   7                        break;
 633   7                      case 4:
 634   7                        GO_4=1;              //open
 635   7                        delay_ms(100);  //>=20
 636   7                        if(1==GI_4)//no open
 637   7                        {
 638   8                          delay_ms(300);
 639   8                        }
 640   7                        if(1==GI_4)//no open
 641   7                        {
 642   8                          delay_ms(600);
 643   8                        } 
 644   7                        GO_4=0;              //close
 645   7      
 646   7                        gpio_level= GI_4;
 647   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 648   7                        break;
 649   7                      case 5:
 650   7                        GO_5=1;              //open
 651   7                        delay_ms(100);  //>=20
 652   7                        if(1==GI_5)//no open
 653   7                        {
 654   8                          delay_ms(300);
 655   8                        }
 656   7                        if(1==GI_5)//no open
 657   7                        {
 658   8                          delay_ms(600);
 659   8                        } 
 660   7                        GO_5=0;              //close
 661   7      
 662   7                        gpio_level= GI_5;
 663   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 664   7                        break;
 665   7                      case 6:
 666   7                        GO_6=1;              //open
 667   7                        delay_ms(100);  //>=20
 668   7                        if(1==GI_6)//no open
 669   7                        {
 670   8                          delay_ms(300);
 671   8                        }
 672   7                        if(1==GI_6)//no open
 673   7                        {
 674   8                          delay_ms(600);
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 12  

 675   8                        }
 676   7                        GO_6=0;              //close
 677   7      
 678   7                        gpio_level= GI_6;
 679   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 680   7                        break;
 681   7                      case 7:
 682   7                        GO_7=1;              //open
 683   7                        delay_ms(100);  //>=20
 684   7                        if(1==GI_7)//no open
 685   7                        {
 686   8                          delay_ms(300);
 687   8                        }
 688   7                        if(1==GI_7)//no open
 689   7                        {
 690   8                          delay_ms(600);
 691   8                        }
 692   7                        GO_7=0;              //close
 693   7      
 694   7                        gpio_level= GI_7;
 695   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 696   7                        break;
 697   7                      case 8:
 698   7                        GO_8=1;              //open
 699   7                        delay_ms(100);  //>=20
 700   7                        if(1==GI_8)//no open
 701   7                        {
 702   8                          delay_ms(300);
 703   8                        }
 704   7                        if(1==GI_8)//no open
 705   7                        {
 706   8                          delay_ms(600);
 707   8                        }
 708   7                        GO_8=0;              //close
 709   7      
 710   7                        gpio_level= GI_2;
 711   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 712   7                        break;
 713   7                      case 9:
 714   7                        GO_9=1;              //open
 715   7                        delay_ms(100);  //>=20
 716   7                        if(1==GI_9)//no open
 717   7                        {
 718   8                          delay_ms(300);
 719   8                        }
 720   7                        if(1==GI_9)//no open
 721   7                        {
 722   8                          delay_ms(600);
 723   8                        }
 724   7                        GO_9=0;              //close
 725   7      
 726   7                        gpio_level= GI_9;
 727   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 728   7                        break;
 729   7                      case 10:
 730   7                        GO_10=1;               //open
 731   7                        delay_ms(100);  //>=20
 732   7                        if(1==GI_10)//no open
 733   7                        {
 734   8                          delay_ms(300);
 735   8                        }
 736   7                        if(1==GI_10)//no open
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 13  

 737   7                        {
 738   8                          delay_ms(600);
 739   8                        } 
 740   7                        GO_10=0;               //close
 741   7      
 742   7                        gpio_level= GI_10;
 743   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 744   7                        break;
 745   7                      case 11:
 746   7                        GO_11=1;               //open
 747   7                        delay_ms(100);  //>=20
 748   7                        if(1==GI_11)//no open
 749   7                        {
 750   8                          delay_ms(300);
 751   8                        }
 752   7                        if(1==GI_11)//no open
 753   7                        {
 754   8                          delay_ms(600);
 755   8                        } 
 756   7                        GO_11=0;               //close
 757   7      
 758   7                        gpio_level= GI_11;
 759   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 760   7                        break;
 761   7                      case 12:
 762   7                        GO_12=1;               //open
 763   7                        delay_ms(100);  //>=20
 764   7                        if(1==GI_12)//no open
 765   7                        {
 766   8                          delay_ms(300);
 767   8                        }
 768   7                        if(1==GI_12)//no open
 769   7                        {
 770   8                          delay_ms(600);
 771   8                        } 
 772   7                        GO_12=0;               //close
 773   7      
 774   7                        gpio_level= GI_12;
 775   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 776   7                        break;
 777   7                      case 13:
 778   7                        GO_13=1;               //open
 779   7                        delay_ms(100);  //>=20
 780   7                        if(1==GI_13)//no open
 781   7                        {
 782   8                          delay_ms(300);
 783   8                        }
 784   7                        if(1==GI_13)//no open
 785   7                        {
 786   8                          delay_ms(600);
 787   8                        } 
 788   7                        GO_13=0;               //close
 789   7      
 790   7                        gpio_level= GI_13;
 791   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 792   7                        break;
 793   7                      case 14:
 794   7                        GO_14=1;               //open
 795   7                        delay_ms(100);  //>=20
 796   7                        if(1==GI_14)//no open
 797   7                        {
 798   8                          delay_ms(300);
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 14  

 799   8                        }
 800   7                        if(1==GI_14)//no open
 801   7                        {
 802   8                          delay_ms(600);
 803   8                        } 
 804   7                        GO_14=0;               //close
 805   7      
 806   7                        gpio_level= GI_14;
 807   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 808   7                        break;
 809   7                      case 15:
 810   7                        GO_15=1;               //open
 811   7                        delay_ms(100);  //>=20
 812   7                        if(1==GI_15)//no open
 813   7                        {
 814   8                          delay_ms(300);
 815   8                        }
 816   7                        if(1==GI_15)//no open
 817   7                        {
 818   8                          delay_ms(600);
 819   8                        } 
 820   7                        GO_15=0;               //close
 821   7      
 822   7                        gpio_level= GI_15;
 823   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 824   7                        break;
 825   7                      case 16:
 826   7                        GO_16=1;               //open
 827   7                        delay_ms(100);  //>=20
 828   7                        if(1==GI_16)//no open
 829   7                        {
 830   8                          delay_ms(300);
 831   8                        }
 832   7                        if(1==GI_16)//no open
 833   7                        {
 834   8                          delay_ms(600);
 835   8                        } 
 836   7                        GO_16=0;               //close
 837   7      
 838   7                        gpio_level= GI_16;
 839   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 840   7                        break;
 841   7                      case 17:
 842   7                        GO_17=1;               //open
 843   7                        delay_ms(100);  //>=20
 844   7                        if(1==GI_17)//no open
 845   7                        {
 846   8                          delay_ms(300);
 847   8                        }
 848   7                        if(1==GI_17)//no open
 849   7                        {
 850   8                          delay_ms(600);
 851   8                        } 
 852   7                        GO_17=0;               //close
 853   7      
 854   7                        gpio_level= GI_17;
 855   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 856   7                        break;
 857   7                      case 18:
 858   7                        GO_18=1;               //open
 859   7                        delay_ms(100);  //>=20
 860   7                        if(1==GI_18)//no open
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 15  

 861   7                        {
 862   8                          delay_ms(300);
 863   8                        }
 864   7                        if(1==GI_18)//no open
 865   7                        {
 866   8                          delay_ms(600);
 867   8                        } 
 868   7                        GO_18=0;               //close
 869   7      
 870   7                        gpio_level= GI_18;
 871   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 872   7                        break;
 873   7                      case 19:
 874   7                        GO_19=1;               //open
 875   7                        delay_ms(100);  //>=20
 876   7                        if(1==GI_19)//no open
 877   7                        {
 878   8                          delay_ms(300);
 879   8                        }
 880   7                        if(1==GI_19)//no open
 881   7                        {
 882   8                          delay_ms(600);
 883   8                        } 
 884   7                        GO_19=0;               //close
 885   7      
 886   7                        gpio_level= GI_19;
 887   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 888   7                        break;
 889   7                      case 20:
 890   7                        GO_20=1;               //open
 891   7                        delay_ms(100);  //>=20
 892   7                        if(1==GI_20)//no open
 893   7                        {
 894   8                          delay_ms(300);
 895   8                        }
 896   7                        if(1==GI_20)//no open
 897   7                        {
 898   8                          delay_ms(600);
 899   8                        }   
 900   7                        GO_20=0;               //close
 901   7      
 902   7                        gpio_level= GI_20;
 903   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 904   7                        break;
 905   7                      case 21:
 906   7                        GO_21=1;               //open
 907   7                        delay_ms(100);  //>=20
 908   7                        if(1==GI_21)//no open
 909   7                        {
 910   8                          delay_ms(300);
 911   8                        }
 912   7                        if(1==GI_21)//no open
 913   7                        {
 914   8                          delay_ms(600);
 915   8                        }  
 916   7                        GO_21=0;               //close
 917   7      
 918   7                        gpio_level= GI_21;
 919   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 920   7                        break;
 921   7                      case 22:
 922   7                        GO_22=1;               //open
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 16  

 923   7                        delay_ms(100);  //>=20
 924   7                        if(1==GI_22)//no open
 925   7                        {
 926   8                          delay_ms(300);
 927   8                        }
 928   7                        if(1==GI_22)//no open
 929   7                        {
 930   8                          delay_ms(600);
 931   8                        } 
 932   7                        GO_22=0;               //close
 933   7      
 934   7                        gpio_level= GI_22;
 935   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 936   7                        break;
 937   7                      case 23:
 938   7                        GO_23=1;               //open
 939   7                        delay_ms(100);  //>=20
 940   7                        if(1==GI_23)//no open
 941   7                        {
 942   8                          delay_ms(300);
 943   8                        }
 944   7                        if(1==GI_23)//no open
 945   7                        {
 946   8                          delay_ms(600);
 947   8                        } 
 948   7                        GO_23=0;               //close
 949   7      
 950   7                        gpio_level= GI_23;
 951   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 952   7                        break;
 953   7                      case 24:
 954   7                        GO_24=1;               //open
 955   7                        delay_ms(100);  //>=20
 956   7                        if(1==GI_24)//no open
 957   7                        {
 958   8                          delay_ms(300);
 959   8                        }
 960   7                        if(1==GI_24)//no open
 961   7                        {
 962   8                          delay_ms(600);
 963   8                        } 
 964   7                        GO_24=0;               //close
 965   7      
 966   7                        gpio_level= GI_24;
 967   7                        //SEGGER_RTT_printf(0, "%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
 968   7                        break;
 969   7      
 970   7                      
 971   7                      default:
 972   7                        break;
 973   7      
 974   7                    }
 975   6                    lock_all_off();
 976   6                    
 977   6                    memcpy(tx_Buffer,"star",4);
 978   6                    tx_Buffer[4]= m_data.opcode;
 979   6                    tx_Buffer[5]= m_data.board_addr;
 980   6                    tx_Buffer[6]= m_data.lock_addr;
 981   6                    
 982   6      //              if(0x00 == gpio_level)
 983   6                    if(0x01 == gpio_level)
 984   6                      tx_Buffer[7]= 0x11;//lock state todo open
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 17  

 985   6                    else
 986   6                      tx_Buffer[7]= 0x00;//lock state todo close
 987   6                    
 988   6                    bcc_temp = ComputXor(tx_Buffer+4,4);
 989   6                    tx_Buffer[8]= bcc_temp;
 990   6                    memcpy(tx_Buffer+9,"end",3);
 991   6                    
 992   6                    tx_Buffer[12]='\0';
 993   6                    
 994   6                    spear_uart_send_datas(tx_Buffer,12);
 995   6      //              spear_rtt_send_datas(tx_Buffer,12);
 996   6      
 997   6                    //SEGGER_RTT_printf(0, "ok,m_data.opcode=%02x\n",m_data.opcode);
 998   6                  }
 999   5                  else
1000   5                  {
1001   6                    //SEGGER_RTT_printf(0, "error-2,m_data.opcode=%02x\n",m_data.opcode);
1002   6                  }
1003   5                  break;
1004   5      
1005   5                case 0x80:
1006   5                  if(m_data.gu_ding  == 0x33)//process
1007   5                  {
1008   6                    if(0x00== m_data.lock_addr)//----4------
1009   6                    {
1010   7      //                debug_uart_send_data1((GI_T_1) | (GI_T_2<<1));
1011   7                      grp_level_1= GI_T_1 | (GI_T_2<<1) | (GI_T_3<<2) | (GI_T_4<<3) | (GI_T_5<<4) | (GI_T_6<<5) | (GI_T_
             -7<<6) | (GI_T_8<<7);
1012   7                      grp_level_2= GI_T_9 | (GI_T_10<<1) | (GI_T_11<<2) | (GI_T_12<<3) | (GI_T_13<<4) | (GI_T_14<<5) | (
             -GI_T_15<<6) | (GI_T_16<<7);
1013   7                      grp_level_3= GI_T_17 | (GI_T_18<<1) | (GI_T_19<<2) | (GI_T_20<<3) | (GI_T_21<<4) | (GI_T_22<<5) | 
             -(GI_T_23<<6) | (GI_T_24<<7);
1014   7                      //SEGGER_RTT_printf(0, "grp_level_1 = %x\n",grp_level_1);
1015   7                      //SEGGER_RTT_printf(0, "grp_level_2 = %x\n",grp_level_2);
1016   7                      //SEGGER_RTT_printf(0, "grp_level_3 = %x\n",grp_level_3);
1017   7                      
1018   7                      memcpy(tx_Buffer,"star",4);
1019   7                      tx_Buffer[4]= m_data.opcode;
1020   7                      tx_Buffer[5]= m_data.board_addr;
1021   7                      tx_Buffer[6]= grp_level_1;
1022   7                      tx_Buffer[7]= grp_level_2;
1023   7                      tx_Buffer[8]= grp_level_3;
1024   7      
1025   7      
1026   7                      
1027   7                      bcc_temp = ComputXor(tx_Buffer+4,5);
1028   7                      tx_Buffer[9]= bcc_temp;
1029   7                      memcpy(tx_Buffer+10,"end",3);//now is 2?
1030   7                      
1031   7                      tx_Buffer[12]='\0';//tx_Buffer[12]='\0';
1032   7                      
1033   7                      spear_uart_send_datas(tx_Buffer,12);
1034   7                      //spear_rtt_send_datas(tx_Buffer,12);//to do 13?
1035   7      
1036   7                      //SEGGER_RTT_printf(0, "ok,m_data.opcode=%02x\n",m_data.opcode);
1037   7                      //spear_uart_send_datas
1038   7                    }
1039   6                    else//----3------
1040   6                    {
1041   7                      
1042   7                      switch(m_data.lock_addr)
1043   7                      {
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 18  

1044   8                        case 1:
1045   8                          gpio_level= GI_1;
1046   8                          break;
1047   8                        case 2:
1048   8                          gpio_level= GI_2;
1049   8                          break;
1050   8                        case 3:
1051   8                          gpio_level= GI_3;
1052   8                          break;
1053   8                        case 4:
1054   8                          gpio_level= GI_4;
1055   8                          break;
1056   8                        case 5:
1057   8                          gpio_level= GI_5;
1058   8                          break;
1059   8                        case 6:
1060   8                          gpio_level= GI_6;
1061   8                        case 7:
1062   8                          gpio_level= GI_7;
1063   8                          break;
1064   8                        case 8:
1065   8                          gpio_level= GI_8;
1066   8                          break;
1067   8                        case 9:
1068   8                          gpio_level= GI_9;
1069   8                          break;
1070   8                        case 10:
1071   8                          gpio_level= GI_10;
1072   8                          break;
1073   8                        case 11:
1074   8                          gpio_level= GI_11;
1075   8                          break;
1076   8                        case 12:
1077   8                          gpio_level= GI_12;
1078   8                          break;
1079   8                        case 13:
1080   8                          gpio_level= GI_13;
1081   8                          break;
1082   8                        case 14:
1083   8                          gpio_level= GI_14;
1084   8                          break;
1085   8                        case 15:
1086   8                          gpio_level= GI_15;
1087   8                        case 16:
1088   8                          gpio_level= GI_16;
1089   8                          break;
1090   8                        case 17:
1091   8                          gpio_level= GI_17;
1092   8                          break;
1093   8                        case 18:
1094   8                          gpio_level= GI_18;
1095   8                          break;
1096   8                        case 19:
1097   8                          gpio_level= GI_19;
1098   8                          break;
1099   8                        case 20:
1100   8                          gpio_level= GI_20;
1101   8                          break;
1102   8                        case 21:
1103   8                          gpio_level= GI_21;
1104   8                          break;
1105   8                        case 22:
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 19  

1106   8                          gpio_level= GI_22;
1107   8                          break;
1108   8                        case 23:
1109   8                          gpio_level= GI_23;
1110   8                          break;
1111   8                        case 24:
1112   8                          gpio_level= GI_24;
1113   8                          break;
1114   8                        
1115   8                        default:
1116   8                          break;
1117   8      
1118   8                      }
1119   7                      //SEGGER_RTT_printf(0, "--%d:gpio_level = %x\n",m_data.lock_addr,gpio_level);
1120   7                      
1121   7                      memcpy(tx_Buffer,"star",4);
1122   7                      tx_Buffer[4]= m_data.opcode;
1123   7                      tx_Buffer[5]= m_data.board_addr;
1124   7                      tx_Buffer[6]= m_data.lock_addr;
1125   7                      
1126   7                      if(0x01 == gpio_level)
1127   7                        tx_Buffer[7]= 0x11;//lock state todo open
1128   7                      else
1129   7                        tx_Buffer[7]= 0x00;//lock state todo close
1130   7      
1131   7                      
1132   7                      bcc_temp = ComputXor(tx_Buffer+4,4);
1133   7                      tx_Buffer[8]= bcc_temp;
1134   7                      memcpy(tx_Buffer+9,"end",3);
1135   7                      
1136   7                      tx_Buffer[12]='\0';
1137   7                      
1138   7                      spear_uart_send_datas(tx_Buffer,12);
1139   7                      //spear_rtt_send_datas(tx_Buffer,12);
1140   7      
1141   7                      //SEGGER_RTT_printf(0, "--ok,m_data.opcode=%02x\n",m_data.opcode);
1142   7                    }
1143   6                    
1144   6                  }
1145   5                  else
1146   5                  {
1147   6                    //SEGGER_RTT_printf(0, "error-2,m_data.opcode=%02x\n",m_data.opcode);
1148   6                  }
1149   5                  break;
1150   5      
1151   5                default:
1152   5                  break;
1153   5              }
1154   4              
1155   4              //SEGGER_RTT_printf(0, "m_data.bcc = %x\n",m_data.bcc);
1156   4            }
1157   3            else
1158   3            {
1159   4              //SEGGER_RTT_printf(0, "error-1-m_data.bcc = %x\n",m_data.bcc);
1160   4            }
1161   3            
1162   3          }
1163   2          else if(3==Uart1_Rx_T)
1164   2          {
1165   3            m_data.opcode = Uart1_Buffer_T[0];
1166   3            m_data.board_addr = Uart1_Buffer_T[1];
1167   3      
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 20  

1168   3            m_data.bcc = Uart1_Buffer_T[2];
1169   3            
1170   3            bcc_temp = ComputXor(Uart1_Buffer_T,2);
1171   3            //SEGGER_RTT_printf(0, "bcc_temp = %x\n",bcc_temp);
1172   3            if(bcc_temp == m_data.bcc)
1173   3            {
1174   4              switch(m_data.opcode)
1175   4              {
1176   5                case 0x90://--------2---------
1177   5                  lock_all_on_off();
1178   5                  grp_level_1= GI_T_1 | (GI_T_2<<1) | (GI_T_3<<2) | (GI_T_4<<3) | (GI_T_5<<4) | (GI_T_6<<5) | (GI_T_7<
             -<6) | (GI_T_8<<7);
1179   5                  grp_level_2= GI_T_9 | (GI_T_10<<1) | (GI_T_11<<2) | (GI_T_12<<3) | (GI_T_13<<4) | (GI_T_14<<5) | (GI
             -_T_15<<6) | (GI_T_16<<7);
1180   5                  grp_level_3= GI_T_17 | (GI_T_18<<1) | (GI_T_19<<2) | (GI_T_20<<3) | (GI_T_21<<4) | (GI_T_22<<5) | (G
             -I_T_23<<6) | (GI_T_24<<7);
1181   5                  //SEGGER_RTT_printf(0, "grp_level_1 = %x\n",grp_level_1);
1182   5                  //SEGGER_RTT_printf(0, "grp_level_2 = %x\n",grp_level_2);
1183   5                  //SEGGER_RTT_printf(0, "grp_level_3 = %x\n",grp_level_3);
1184   5                  
1185   5                  memcpy(tx_Buffer,"star",4);
1186   5                  tx_Buffer[4]= 0x80;//m_data.opcode;
1187   5                  tx_Buffer[5]= m_data.board_addr;
1188   5                  tx_Buffer[6]= grp_level_1;
1189   5                  tx_Buffer[7]= grp_level_2;
1190   5                  tx_Buffer[8]= grp_level_3;
1191   5      
1192   5      
1193   5                  
1194   5                  bcc_temp = ComputXor(tx_Buffer+4,5);
1195   5                  tx_Buffer[9]= bcc_temp;
1196   5                  memcpy(tx_Buffer+10,"end",3);//now is 2?
1197   5                  
1198   5                  tx_Buffer[12]='\0';//tx_Buffer[12]='\0';
1199   5                  
1200   5                  spear_uart_send_datas(tx_Buffer,12);
1201   5                  //SEGGER_RTT_printf(0, "ok,m_data.opcode=%02x\n",m_data.opcode);
1202   5                  break;
1203   5                case 0x91://--------2.1---------
1204   5                  lock_all_on_off();
1205   5                  grp_level_1= GI_T_1 | (GI_T_2<<1) | (GI_T_3<<2) | (GI_T_4<<3) | (GI_T_5<<4) | (GI_T_6<<5) | (GI_T_7<
             -<6) | (GI_T_8<<7);
1206   5                  grp_level_2= GI_T_9 | (GI_T_10<<1) | (GI_T_11<<2) | (GI_T_12<<3) | (GI_T_13<<4) | (GI_T_14<<5) | (GI
             -_T_15<<6) | (GI_T_16<<7);
1207   5                  grp_level_3= GI_T_17 | (GI_T_18<<1) | (GI_T_19<<2) | (GI_T_20<<3) | (GI_T_21<<4) | (GI_T_22<<5) | (G
             -I_T_23<<6) | (GI_T_24<<7);
1208   5                  //SEGGER_RTT_printf(0, "grp_level_1 = %x\n",grp_level_1);
1209   5                  //SEGGER_RTT_printf(0, "grp_level_2 = %x\n",grp_level_2);
1210   5                  //SEGGER_RTT_printf(0, "grp_level_3 = %x\n",grp_level_3);
1211   5                  
1212   5                  memcpy(tx_Buffer,"star",4);
1213   5                  tx_Buffer[4]= 0x80;//m_data.opcode;
1214   5                  tx_Buffer[5]= m_data.board_addr;
1215   5                  tx_Buffer[6]= grp_level_1;
1216   5                  tx_Buffer[7]= grp_level_2;
1217   5                  tx_Buffer[8]= grp_level_3;
1218   5      
1219   5      
1220   5                  
1221   5                  bcc_temp = ComputXor(tx_Buffer+4,5);
1222   5                  tx_Buffer[9]= bcc_temp;
1223   5                  memcpy(tx_Buffer+10,"end",3);//now is 2?
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 21  

1224   5                  
1225   5                  tx_Buffer[12]='\0';//tx_Buffer[12]='\0';
1226   5                  
1227   5                  spear_uart_send_datas(tx_Buffer,12);
1228   5                  //SEGGER_RTT_printf(0, "ok,m_data.opcode=%02x\n",m_data.opcode);
1229   5                  break;
1230   5                case 0x92://--------2.2---------
1231   5                  //SEGGER_RTT_printf(0, "ok,m_data.opcode=%02x\n",m_data.opcode);
1232   5                  break;
1233   5                case 0x93://--------2.3---------
1234   5                  //SEGGER_RTT_printf(0, "ok,m_data.opcode=%02x\n",m_data.opcode);
1235   5                  break;
1236   5                case 0x70://--------2.4---------
1237   5                  //SEGGER_RTT_printf(0, "ok,m_data.opcode=%02x\n",m_data.opcode);
1238   5                  break;
1239   5                case 0x71://--------2.5---------
1240   5                  //SEGGER_RTT_printf(0, "ok,m_data.opcode=%02x\n",m_data.opcode);
1241   5                  break;          
1242   5                default:
1243   5                  break;
1244   5              }
1245   4              //todo
1246   4              
1247   4              //SEGGER_RTT_printf(0, "m_data.bcc = %x\n",m_data.bcc);
1248   4            }
1249   3            else
1250   3            {
1251   4              //SEGGER_RTT_printf(0, "error-1-m_data.bcc = %x\n",m_data.bcc);
1252   4            }
1253   3          
1254   3          }
1255   2          
1256   2          
1257   2          
1258   2        }
1259   1      
1260   1      }
1261          
1262          void gpio_init(void)
1263          {
1264   1        P1M0 = 0x6F;                                //??P1.0~P1.7???????
1265   1        P1M1 = 0x00;
1266   1      
1267   1        P2M0 = 0x66;                                //
1268   1        P2M1 = 0x00;
1269   1        
1270   1        P3M0 = 0x18;                                //
1271   1        P3M1 = 0x00;
1272   1        
1273   1        P4M0 = 0x03;                                //
1274   1        P4M1 = 0x00;
1275   1        
1276   1        P5M0 = 0x2F;                                //
1277   1        P5M1 = 0x00;
1278   1        
1279   1        P6M0 = 0x8C;                                //
1280   1        P6M1 = 0x00;
1281   1        
1282   1        P7M0 = 0x09;                                //
1283   1        P7M1 = 0x00;
1284   1        
1285   1        lock_all_off();
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 22  

1286   1      
1287   1      }
1288          
1289          
1290          /******************************************************************************/
1291          // º¯ÊýÃû³Æ£ºmain 
1292          // ÊäÈë²ÎÊý£º 
1293          // Êä³ö²ÎÊý£º 
1294          // º¯Êý¹¦ÄÜ£º 
1295          /******************************************************************************/
1296          void main(void)
1297          {
1298   1      //  uint16 ADC_RES;
1299   1        uint32_t tick_times=0;
1300   1          
1301   1        Uart1Init();
1302   1      //  Timer4_Init();
1303   1        Timer0_Init();
1304   1        ES = 1;
1305   1        EA = 1;
1306   1      //  Read_ID_fromROM();  
1307   1      ////  ADC_Init();
1308   1      //  PWM0_INIT();
1309   1      //  PCA_INIT();
1310   1        
1311   1        gpio_init();
1312   1      
1313   1        
1314   1        RS485_RX_EN();
1315   1      
1316   1        //UartSendStr("power on !!!\r\n");
1317   1        while(1)
1318   1        {
1319   2          if((1== packerflag))
1320   2          {
1321   3            RS485_TX_EN();
1322   3      
1323   3      //      SEGGER_RTT_printf(0, "\n");
1324   3      //      SEGGER_RTT_printf(0, "-main-Uart1_Rx = %d\n",Uart1_Rx);      //RTT´òÓ¡
1325   3      //      SEGGER_RTT_printf(0, "---rcv-datas---"); 
1326   3            //spear_rtt_send_datas(Uart1_Buffer,Uart1_Rx);
1327   3            
1328   3            //spear_uart_send_datas(Uart1_Buffer,Uart1_Rx); //debug
1329   3      
1330   3      
1331   3            data_parse();
1332   3            RS485_RX_EN();
1333   3            
1334   3            memset(Uart1_Buffer,0,13);//max =4+5+4 =13
1335   3            Uart1_Rx   = 0 ;
1336   3            packerflag = 0;
1337   3            //Uart1_index_flag_end =0;
1338   3          }
1339   2          
1340   2          tick_times++;
1341   2          if(tick_times%1000==0)
1342   2          {
1343   3            //SEGGER_RTT_printf(0, "---test1---\n"); 
1344   3            LED1=0;
1345   3            delay_ms(50); 
1346   3            LED1=1;
1347   3          }
C51 COMPILER V9.60.0.0   MAIN                                                              06/18/2020 15:51:22 PAGE 23  

1348   2          delay_ms(5); 
1349   2          
1350   2        
1351   2          
1352   2        }
1353   1      }
1354          
1355          
1356          
1357          
1358          
1359          //    LED1 = 0;
1360          ////    GO_1 = 0;
1361          //    Delay100ms();
1362          //    Delay100ms();
1363          //    Delay100ms();
1364          //    Delay100ms();
1365          //    Delay100ms();
1366          //    LED1 = 1;
1367          ////    GO_1 =1;
1368          //    Delay100ms();
1369          //    Delay100ms();
1370          //    Delay100ms();
1371          //    Delay100ms();
1372          //    Delay100ms();
1373          
1374          //    ADC_RES = Get_ADC_RES();
1375          //    UartSend(ADC_RES);
1376          //    ADC_RES = ADC_RES>>8;
1377          //    UartSend(ADC_RES>>8);
1378              
1379          
1380          //    UartSend(length);
1381          //    UartSend(length>>8);
1382          //    UartSend(length>>16);
1383          //    UartSend(length>>24);
1384          //    RS485_RX_EN();
1385          //    UartSendStr("Uart Test 2 -RX!\r\n");
1386          //    delay_ms(4000);
1387          //    
1388          //    RS485_TX_EN();
1389          //    UartSendStr("Uart Test 3 -TX!\r\n");//no xianshi
1390          //    delay_ms(2100);


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4170    ----
   CONSTANT SIZE    =    521    ----
   XDATA SIZE       =      5     572
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
